# 游戏规则更新说明

## 更新日期：2025年11月20日

## 核心规则变更

### 1. **移除"同意"功能**
- **旧规则**：下家可以选择"同意"、"质疑"或"继续出牌"
- **新规则**：下家只能选择"质疑"或"继续出牌"（移除了接受声明的选项）
- **影响**：游戏节奏更快，每次出牌后必然产生行动（要么质疑，要么继续）

### 2. **支持一次出多张牌（1-3张）**
- **旧规则**：每次只能出1张牌
- **新规则**：每次可以出1-3张牌
- **限制**：
  - 最少出1张
  - 最多出3张
  - 不能超过手牌数量

### 3. **多牌验证规则：全真才为真**
- **旧规则**：出一张牌，验证这张牌是否为真
- **新规则**：出多张牌时，**所有牌都必须是真牌才算说真话**
- **示例**：
  - 桌面牌面是Q
  - 玩家出3张牌：Q、Q、K
  - 结果：算作说谎（因为有一张K）

## 代码改动详情

### 修改的核心类

#### 1. `LastClaim` 类
```csharp
// 旧版本
public class LastClaim
{
    public int PlayerIndex;
    public string CardId;        // 单张牌ID
    public Rank DeclaredRank;
}

// 新版本
public class LastClaim
{
    public int PlayerIndex;
    public List<string> CardIds; // 多张牌ID列表
    public Rank DeclaredRank;
    public int CardCount => CardIds?.Count ?? 0;
}
```

#### 2. `IAgent` 接口
```csharp
// 旧版本
public interface IAgent
{
    string Name { get; }
    string ChooseClaimCard(GameState s, int playerIndex, Random rng);  // 返回单张牌ID
    bool DecideChallenge(GameState s, int responderIndex, Random rng);
}

// 新版本
public interface IAgent
{
    string Name { get; }
    List<string> ChooseClaimCards(GameState s, int playerIndex, Random rng); // 返回1-3张牌ID列表
    bool DecideChallenge(GameState s, int responderIndex, Random rng);
}
```

#### 3. `ProcessResponsePhase()` 方法
```csharp
// 旧版本
void ProcessResponsePhase()
{
    // ... 代码省略 ...
    
    if (决定质疑)
        ResolveChallenge(responder);
    else
    {
        // 触发"接受声明"事件
        Events.TriggerClaimAccepted(...);
        // 切换到下一个玩家
    }
}

// 新版本
void ProcessResponsePhase()
{
    // ... 代码省略 ...
    
    if (决定质疑)
        ResolveChallenge(responder);
    else
    {
        // 移除"接受声明"事件
        // 直接切换到下一个玩家继续出牌
        State.Phase = Phase.Claim;
    }
}
```

#### 4. `ResolveChallenge()` 方法
```csharp
// 旧版本
void ResolveChallenge(int responderIndex, bool isFinalShowdown = false)
{
    var lastCard = State.Pile.Last();
    bool truthful = (lastCard.Rank == State.TableRank); // 单张验证
    // ...
}

// 新版本
void ResolveChallenge(int responderIndex, bool isFinalShowdown = false)
{
    var claimedCardCount = State.LastClaim.CardCount;
    var lastCards = State.Pile.Skip(State.Pile.Count - claimedCardCount).ToList();
    bool truthful = lastCards.All(card => card.Rank == State.TableRank); // 所有牌都为真才算真
    // ...
}
```

### 更新的AI实现

#### RandomBot（随机Bot）
- **策略**：随机选择1-3张牌出牌
- **质疑概率**：30%固定概率

#### CautiousBot（谨慎Bot）
- **出牌策略**：
  - 有真牌时：出1-2张真牌
  - 无真牌时：只出1张假牌（谨慎bluff）
- **质疑概率**：
  - 手里有真牌时：10%
  - 手里无真牌时：30%

#### RecklessBot（莽夫Bot）
- **出牌策略**：随机出1-3张牌（不管真假）
- **质疑概率**：
  - 手里有真牌时：50%
  - 手里无真牌时：80%

## 游戏流程示例

### 场景：4人游戏，桌面牌面为Q

1. **玩家1出牌**：出3张牌，声称都是Q
2. **玩家2响应**：
   - 选项A：质疑 → 翻牌验证（如果3张都是Q则玩家2失败，否则玩家1失败）
   - 选项B：不质疑 → 轮到玩家2出牌
3. **玩家2出牌**：出2张牌，声称都是Q
4. **玩家3响应**：选择质疑或继续...

## 影响与平衡

### 游戏节奏
- ✅ 更快：移除"同意"选项，减少无意义回合
- ✅ 更激烈：多张牌增加赌博成分

### 策略深度
- ✅ 增加：玩家需要决定出几张牌
- ✅ 风险管理：出多张牌风险更高（全真才为真）
- ✅ 诈唬空间：可以混合出真假牌来迷惑对手

### AI平衡性
- **谨慎Bot**：倾向少出牌，保守策略
- **莽夫Bot**：倾向多出牌，激进策略
- **随机Bot**：不可预测性高

## 未来扩展建议

1. **动态出牌数量上限**：根据存活玩家数调整（如2人时最多出2张）
2. **特殊牌型奖励**：出3张真牌时可以获得额外优势
3. **连续出牌机制**：成功骗过对手后可以继续出牌
4. **手牌数不足处理**：当手牌少于3张时的特殊规则

## 测试检查清单

- [ ] 验证1张牌出牌功能
- [ ] 验证2张牌出牌功能
- [ ] 验证3张牌出牌功能
- [ ] 验证全真判定（3张都是Q）
- [ ] 验证部分真判定（2张Q + 1张K = 假）
- [ ] 验证全假判定（3张K = 假）
- [ ] 验证移除"接受声明"事件后UI正常
- [ ] 验证3种AI在新规则下的表现
- [ ] 验证手牌不足时的边界情况（如只剩1张牌）
- [ ] 验证重新发牌机制是否正常

---

**注意**：此次更新需要同步更新UI显示逻辑（如显示出牌数量）和事件监听（移除ClaimAccepted相关处理）。
