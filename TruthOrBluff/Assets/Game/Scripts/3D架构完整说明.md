# 3D圆桌游戏架构完整说明

## 📦 已创建的文件清单

### 核心脚本
1. **PlayerController.cs** - 3D场景中的玩家实体控制器
2. **PlayerSpawnManager.cs** - 玩家生成管理器（圆形布局）
3. **Card3DView.cs** - 3D卡牌显示组件
4. **CharacterAnimationController.cs** - 角色动画控制器

### 修改的文件
1. **GamePresenter.cs** - 适配3D玩家系统
2. **GameRunner.cs** - 添加清理玩家功能

### 文档
1. **场景搭建指南.md** - 完整的Unity场景搭建步骤
2. **3D游戏架构重构说明.md** - 架构设计理念

---

## 🎯 核心设计理念

### 从2D UI到3D场景

**之前 (错误设计):**
```
Canvas
└── PlayerView (UI元素)
    └── 附带生成3D角色
```

**现在 (正确设计):**
```
3D场景
└── PlayerController (3D对象)
    ├── CharacterModel (主体)
    └── WorldSpaceUI (附属)
```

---

## 🔄 工作流程

### 游戏初始化流程

```
1. GameRunner.Start()
   └── InitializeGame()
       ├── 创建 GameConfig
       ├── 创建 AI 代理
       └── GameEngine.Initialize()
           └── 触发 OnGameInitialized 事件

2. GamePresenter 接收事件
   └── OnGameInitialized()
       └── PlayerSpawnManager.SpawnPlayers()
           └── 在圆形轨迹上生成玩家
               └── PlayerController.Initialize()
                   ├── 生成角色模型
                   ├── 创建世界空间UI
                   └── 初始化手牌显示
```

### 游戏运行流程

```
1. 玩家回合开始
   └── OnTurnChanged 事件
       └── 所有 PlayerController 更新高亮
           └── 当前玩家播放思考动画

2. 玩家出牌
   └── OnCardPlayed 事件
       └── PlayerController.PlayCardAnimation()
           ├── 播放角色动画
           ├── 更新手牌显示
           └── MMFeedbacks 特效

3. 玩家淘汰
   └── OnPlayerEliminated 事件
       └── PlayerController.PlayEliminatedAnimation()
           └── 角色倒下/淡出

4. 游戏结束
   └── OnGameOver 事件
       └── 获胜者.PlayWinAnimation()
```

---

## 🎨 玩家布局系统

### 圆形排列算法

```csharp
// 计算位置（极坐标转笛卡尔坐标）
float angle = playerIndex * (360° / totalPlayers);
float x = centerX + radius * sin(angle);
float z = centerZ + radius * cos(angle);

// 计算旋转（朝向中心）
Vector3 lookDirection = tableCenter - playerPosition;
rotation = Quaternion.LookRotation(lookDirection);
```

### 支持的玩家数量

- ✅ 2人: 对面坐
- ✅ 3人: 等边三角形
- ✅ 4人: 正方形（默认）
- ✅ 5人: 五边形
- ✅ 6人: 六边形
- ✅ 任意人数: 自动均匀分布

---

## 🎮 组件职责

### PlayerController
**职责**: 3D场景中的玩家完整表示
- 角色模型管理
- 世界空间UI显示
- 手牌3D显示
- 动画播放
- 特效触发

**不负责**: 
- ❌ 游戏逻辑（由GameEngine处理）
- ❌ AI决策（由IAgent处理）

### PlayerSpawnManager
**职责**: 玩家生成和位置管理
- 计算圆形位置
- 实例化PlayerController
- 分配角色模型
- 管理玩家生命周期

**不负责**:
- ❌ 玩家交互
- ❌ UI更新

### GamePresenter
**职责**: 事件监听和协调
- 监听GameEngine事件
- 调用PlayerController方法
- 更新屏幕UI

**不负责**:
- ❌ 直接创建GameObject（委托给SpawnManager）
- ❌ 游戏逻辑

---

## 📐 坐标系统

### 桌子中心坐标
```
世界坐标: (0, 0, 0)
所有玩家围绕这个点排列
```

### 玩家局部坐标
```
PlayerController
├── CharacterRoot (0, 0, 0)
├── WorldSpaceUI (0, 2, 0) ← 头顶上方
└── CardHoldPoint (-0.3, 1.2, 0.2) ← 左手位置
```

### UI坐标（世界空间）
```
Canvas Scale: (0.01, 0.01, 0.01)
Canvas Size: (200, 100)
实际世界大小: 2m × 1m
```

---

## 🎬 动画系统

### 触发时机

| 动画 | 触发事件 | 方法 |
|------|---------|------|
| Idle | 初始化/待机 | PlayIdle() |
| Think | 回合开始 | PlayThinkAnimation() |
| PlayCard | 出牌 | PlayCardAnimation() |
| Win | 游戏胜利 | PlayWinAnimation() |
| Lose | 被淘汰 | PlayEliminatedAnimation() |

### Animator Controller 设置

```
参数（Triggers）:
- Idle
- Think
- PlayCard
- Win
- Lose

状态机:
[Any State] ──> [Think] (when Think triggered)
[Think] ──> [PlayCard] (when PlayCard triggered)
[PlayCard] ──> [Idle] (on animation end)
...
```

---

## 🃏 手牌显示系统

### 手持方式（当前实现）

```
CardHoldPoint (左手位置)
└── Card_0 (rotation: -15°)
└── Card_1 (rotation: 0°)
└── Card_2 (rotation: 15°)
└── ... (扇形排列)
```

### 参数配置

```csharp
fanAngle = 15f;  // 每张牌之间的角度
cardSpacing = 0.02f;  // 牌之间的水平间距
```

### 显示控制

```csharp
// 仅本地玩家显示手牌正面
if (PlayerIndex == 0) // 假设玩家1是本地玩家
{
    controller.ShowHandCards = true;
}
```

---

## 🔧 配置参数

### PlayerSpawnManager 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| Table Radius | 3.0 | 玩家距离中心的距离（米）|
| Player Height | 0.0 | 玩家Y轴偏移 |
| Character Prefabs | [] | 角色模型数组 |
| Player Controller Prefab | null | PlayerController模板 |

### PlayerController 参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| Show Hand Cards | false | 是否显示手牌 |
| Alive Color | Green | 存活状态颜色 |
| Dead Color | Red | 淘汰状态颜色 |
| Active Turn Color | Yellow | 当前回合颜色 |

---

## 🎯 最小可运行配置

### 不需要3D模型也能运行

1. **临时角色**: 使用Unity Cube代替
2. **临时桌子**: 使用Unity Cylinder
3. **临时卡牌**: 使用Unity Plane + TextMeshPro

### 快速测试步骤

```
1. 创建空场景
2. 添加 GameTable + PlayerSpawnManager
3. 创建简单的 PlayerController 预制体（只要有UI）
4. 添加 GamePresenter + GameRunner
5. 点击 Play ✅
```

---

## 📊 性能优化

### 已实现的优化

- ✅ UI朝向更新放在 LateUpdate（避免闪烁）
- ✅ 手牌显示仅在变化时更新
- ✅ 事件驱动架构（无需每帧轮询）
- ✅ 对象复用（PlayerData不重复创建）

### 可扩展的优化

- 🔄 对象池（频繁创建的卡牌对象）
- 🔄 LOD系统（远处玩家降低精度）
- 🔄 Culling（不可见对象禁用渲染）
- 🔄 异步加载（大型角色模型）

---

## 🐛 调试工具

### Scene视图 Gizmos

```
在编辑器中可以看到:
- 🟡 黄色圆圈: 玩家生成轨迹
- 🔵 蓝色球体: 玩家位置预览
- ➡️ 箭头: 玩家朝向
- 🔷 青色球: 手牌持握点
```

### 控制台日志

```csharp
[GamePresenter] 游戏初始化：4名玩家
[PlayerController] Player 0 (玩家1) 初始化完成
[PlayerSpawnManager] 生成玩家 0 在位置 (0, 0, -3)
```

### 运行时GUI按钮

```
左上角按钮面板:
- 步进: 执行一步游戏逻辑
- 运行到底: 快速完成游戏
- 重新开始: 清理并重新初始化
- 自动播放: 开关自动步进
```

---

## 🚀 下一步建议

### 基础完善
1. ✅ 搭建基础场景
2. ✅ 测试玩家生成
3. ✅ 验证事件触发
4. ⬜ 添加真实角色模型
5. ⬜ 设计卡牌3D模型

### 交互增强
1. ⬜ 点击玩家查看信息
2. ⬜ 摄像机跟随当前玩家
3. ⬜ 拖拽旋转视角

### 视觉效果
1. ⬜ 粒子特效（出牌、胜利）
2. ⬜ 后处理（景深、泛光）
3. ⬜ 动态光照

### 音效
1. ⬜ 出牌音效
2. ⬜ 质疑音效
3. ⬜ 胜利音乐
4. ⬜ 背景音乐

---

## 📚 相关文件

- `场景搭建指南.md` - 详细的Unity场景搭建步骤
- `3D游戏架构重构说明.md` - 设计理念和方案对比
- `架构设计.md` - 整体系统架构文档

---

## ✅ 总结

### 核心改进

1. **3D优先**: 角色是主体，UI是附属
2. **动态生成**: 支持任意玩家数量
3. **圆形布局**: 自动计算均匀分布
4. **手持卡牌**: 真实的3D手牌显示
5. **事件驱动**: 解耦的架构设计

### 适用场景

- ✅ 桌游类3D游戏
- ✅ 多人回合制游戏
- ✅ 需要角色围坐的游戏
- ✅ 卡牌类3D游戏

---

**现在系统已经完全适配3D游戏了！** 🎮

可以开始按照《场景搭建指南》一步步实现你的游戏场景。
